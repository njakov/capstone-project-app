name: 03 - Production Release

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker Tag to Deploy (e.g., 1.0.5)'
        required: true
        type: string

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

jobs:
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - uses: actions/checkout@v4

      # 1. Guardrail: Check Tag Format
      - name: Verify Tag format
        run: |
          if [[ ! "${{ inputs.image_tag }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Production tags must be semantic versions (e.g., 1.0.0). You provided: ${{ inputs.image_tag }}"
            exit 1
          fi

      
      - name: 'Docker Auth'
        run: gcloud auth configure-docker ${{ vars.GCP_REGION }}-docker.pkg.dev

      # 3. Image Promotion (Dev Registry -> Prod Registry)
      # Since Terraform created two separate repos, we must move the image.
      - name: Promote Image to Prod Registry
        run: |
          DEV_IMAGE="${{ vars.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/petclinic-repo-dev/petclinic:${{ inputs.image_tag }}"
          PROD_IMAGE="${{ vars.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ vars.ARTIFACT_REPO }}/petclinic:${{ inputs.image_tag }}"
          
          echo "Pulling from Dev..."
          docker pull $DEV_IMAGE
          
          echo "Retagging for Prod..."
          docker tag $DEV_IMAGE $PROD_IMAGE
          
          echo "Pushing to Prod..."
          docker push $PROD_IMAGE

      # 4. Get GKE Credentials (PROD Cluster)
      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ vars.GKE_CLUSTER }}
          location: ${{ vars.GCP_REGION }}

      # 5. Deploy Helm Chart to PROD
      - name: Deploy to Prod
        run: |
          helm upgrade --install petclinic ./chart/petclinic \
            --set image.repository="${{ vars.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ vars.ARTIFACT_REPO }}/petclinic" \
            --set image.tag="${{ inputs.image_tag }}" \
            --set cloudSql.instanceConnectionName="${{ vars.DB_INSTANCE }}" \
            --set replicaCount=2 \
            --wait

      - name: Verify Deployment
        run: |
          kubectl get services
          echo "Production Deployment Complete. Access the application via the External IP above."