name: 01 - PR Gatekeeper

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  PROJECT_ID: "teak-advice-475415-i2"
  REGION: "europe-west1"
  REPO_NAME: "petclinic-repo-dev"

jobs:
  pr-lifecycle:
    runs-on: [self-hosted, dev]
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      # 1. Calculate Short SHA (7 letters)
      - name: Set Short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT

      # 2. Static Analysis, Tests, Build Report & Package
      # 'verify' runs checkstyle, unit tests, and packages the application
      - name: Build and Verify (Tests + Checkstyle)
        run: ./mvnw verify

      # 3. Authenticate to Google Cloud
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Docker Auth'
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # 4. Build Docker Image (Load for Scanning)
      # We build it first to scan it locally before pushing
      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/petclinic:${{ steps.vars.outputs.sha_short }}

      # 5. Security Scan (Trivy on Image)
      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@0.16.1
        with:
          image-ref: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/petclinic:${{ steps.vars.outputs.sha_short }}
          format: 'table'
          exit-code: '1' # Fail pipeline if CRITICAL/HIGH issues found
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      # 6. Push Image (SHA + Latest)
      - name: Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/petclinic:${{ steps.vars.outputs.sha_short }}
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/petclinic:latest